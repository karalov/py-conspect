cd file with accounts (inventory)
[redhat]
karalov01 ansible_ssh_user=ec2-user
karalov02 ansible_ssh_user=ec2-user
[ubuntu]
karalov03 ansible_ssh_user=ec2-user
---
#adhock:
>ansible redhat -m ping -i inventory
#Install a package
>ansible ubuntu -m apt -a "name=git" -i inventory
>ansible redhat -m yum -a "name=git" -i inventory
#Run a bash command:
                -m command -a "ls"
#Copy a file
				-m copy -a"src=inventory dest="ansible/"

#playbooks
 ---
 - name: install git on Ubuntu
   hosts: ubuntu
   become: True
   tasks:
      - name: install git
	    apt: name=git
		
- name: install git on redhat
   hosts: redhat
   become: True
   vars:
      package: git
   tasks:
      - name: install {{ package }}
	    yum: name="{{ package }}" 
		
ansible-playbook myplaybook.yml -i inventory

#variables.yml
---
package: git

---
- name: install {{ package }}
   hosts: all
   become: True
   vars_files:
     - variables.yml
   tasks:
      - name: update cache on Ubuntu
	    apt:
		  update_cache: True
		when: ansible_os_family == "Debian"

      - name: upgrade Ubuntu
	    apt:
		  upgrade: True
		when: ansible_os_family == "Debian"
		
      - name: install {{ package }} on RedHat
	    yum: name="{{ package }}" state=present
		register: success
		when: ansible_on_family == "RedHat"
	  - debug: var=success
		
		
      - name: install {{ package }} on Ubuntu
	    apt: name="{{ package }}" state=present
		when: ansible_on_family == "Ubuntu"
		gather_facts: False
		
      - name: remove {{ package }} on RedHat
	    yum: 
		   name: "{{ package }}" 
		   state=absent
		when: ansible_on_family == "RedHat"

#--- COMMAND MODULES --
# "shell":
#Use when no existing module or complex requirements (pipes, redirection, grep, awk)
# "command" 
#for simple shell commands, does not support pipes and redirection
# "raw"
#- bypasses the module subsystem
#- used when python in not installed on remote system (Windows)
#- systems with old python (<2.4)
#- network devices (routers, switches)

tasks:
  - name: see network configuration
    shell: ifconfig | grep ens33
    args:
     executable: /bin/bash
    register: net_config
  - debug: var=net_config
   
  - name: copy custom script
    copy:
       src: hello.py
       dest: ~/Desktop	   

  - name: run the script
    command: hello.py
    args:
       chdir: /home/ec2-user/Desktop

  - name: run the script
    raw: bash /home/ec2-user/Desktop/hello.py
 
 
 #--- FILE MODULE -- 
 - name: using file
   hosts: all
   gather_facts: False
   tasks:
     - name: create a directory
       file:
         path: /home/ec2-user/ansible
         state: directory
     - name: create a file
       file:
         path: /home/ec2-user/ansible/hello.txt
         state: touch         
      - name: create a symbolic link
        file:
          src: /home/ec2-user/ansible/hello.txt
          dest: /home/ec2-user/ansible/hello.txt
          state: link           
      - name: delete all
        file:
          path: /home/ec2-user/ansible
          state: absent
# -- FILE MANIPULATIONS/UPDATES -- 
- name: File operations
  hosts: all
  gather_facts: False
  tasks:
    - name: insert text in the end of the file
      lineinfile:
        path: /home/ec2-user/ansible/hello.txt
        line: Hello mummy!
    - name: insert text after specific line
      lineinfile:
        path: /home/ec2-user/ansible/hello.txt
        line: I love you
        insertafter: Hello mummy!
    - name: insert block
      blockinfile:
        path: /home/ec2-user/ansible/hello.txt
        block: |
          Hello my dear friend!
          I want you to be happy
    - name: replace string 
      replace:
        path: /home/ec2-user/ansible/hello.txt
        regexp: be happy
        replace: help me

# Repositories:
# Debian: /etc/apt/sources.list
# Custom repositories: /etc/apt/sourcses.list.d/docker.list
# Yum (redHat)
# /etc/yum.conf
# Extra(custom) under /etc/yum.repos.d/<package>.repo
# Below playbook installs docker
# varfile docker_vars.yml
---
ubuntu_packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - software-properties-common
redhat_packages:
  - lvm2
  - device-mapper-persistent-data
  - yum-utils

#playbook:
---
- name: install ELK stack
  hosts: all
  become: True
  vars_files:
      - docker_vars.yml
  tasks:
    - name: install ubuntu packages
      apt:
        name: "{{ ubuntu_packages }}"
        state: present
      when: ansible_os_family == "Debian"

    - name: install redhat packages
      yum:
        name: "{{ redhat_packages }}"
        state: present
      when: ansible_os_family == "RedHat"

    - name: add Ubuntu GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      when: ansible_os_family == "Debian"

    - name: add docker repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
        state: present
        filename: docker
      when: ansible_os_family == "Debian"

    - name: add docker repo for RedHat
      get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker.repo 
      when: ansible_os_family == "RedHat"

    - name: update caches for ubuntu
      apt:
         update_cache: yes
      when: ansible_os_family == "Debian"

    - name: update caches for redhat
      yum:
        name: "*"
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: install docker on ubuntu
      apt:
        name: docker-ce
        state: present
      when: ansible_os_family == "Debian"

    - name: install docker on radhat
      yum:
        name: docker-ce
        state: present
      when: ansible_os_family == "RedHat"

#Below playbook will install docker containers elastic search, logstash, kibana
---
- name: install python packages
  hosts: all
  become: True
  tasks:

  - name: setup elastic search
    docker_container:
      name: elasticsearch
      state: started
      image: docker.elastic.co/elasticsearch/elasticsearch:6.3.0
      exposed_ports:
        - 9200:9200

  - name: setup Logstash
    docker_container:
      name: logstash
      state: started
      image: docker.elastic.co/logstash/logstash:6.3.0
      exposed_ports:
        - 5044:5044
      links:
        - elasticsearch

  - name: setup Kibana
    docker_container:
      name: kibana
      state: started
      image: docker.elastic.co/kibana/kibana:6.3.0
      links:
        - elasticsearch
      exposed_ports:
        - 5061:5061

# Templates
---
- name: configure network
  hosts: all
  become: True
  tasks:

  - name: configure Ubuntu
    template:
      src: ubuntu_net_config.j2
      dest: /etc/network/interfaces
    when: ansible_os_family == "Debian"

